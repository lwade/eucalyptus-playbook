# Improvements:
# - vars_prompts for all the vars?
# - move vars to a var file which acts as a config template
# - conditional check for VT
#
# Caveats:
# - requires ansible 0.8 or higher
# - assumes static networking
# - lacks conditional statements to offer repeatability (config mgmt)

- hosts: nc
  user: root
  vars_files: 
    - nodecontroller.yml
    - ../../rhn.yml

#  sudo: True
#  vars:
#   euca_version: 3.1
#  eucatools_version: 2.1
#    loglevel: INFO
#    nc_port: 8775
#    hypervisor: KVM
#    virtio_root: 1
#    virtio_block: 1
#    virtio_net: 1
#    public_iface: em1
#    use_bridge: yes
#    bridge: br0
#    bridge_iface: em1
#    bridge_mac: ansible_${bridge_iface}.macaddress
#    network_mode: MANAGED-NOVLAN
#    nc_gateway: 10.104.0.1
       
  tasks:

#   Section for debugging random stuff.
#  - name: debug
#    local_action: debug msg=$euca_version
#    tags: debug

  - name: Download the Eucalyptus repo
    action: get_url url=http://downloads.eucalyptus.com/software/eucalyptus/${euca_version}/rhel/6/x86_64/eucalyptus-release-${euca_version}.noarch.rpm dest=/root/ thirsty=yes
#    action: command rpm -Uvh /root/eucalyptus-release-${euca_version}.noarch.rpm
  
  - name: Download the Euca2ools repo
    action: get_url url=http://downloads.eucalyptus.com/software/euca2ools/${eucatools_version}/rhel/6/x86_64/euca2ools-release-${eucatools_version}.noarch.rpm dest=/root/ thirsty=yes
#    action: command rpm -Uvh /root/euca2ools-release-${eucatools_version}.noarch.rpm
    
  - name: Download the EPEL repo
    action: get_url url=http://downloads.eucalyptus.com/software/eucalyptus/${euca_version}/rhel/6/x86_64/epel-release-6.noarch.rpm dest=/root/ thirsty=yes
#    action: command rpm -Uvh /root/epel-release-6.noarch.rpm
    
  - name: Download the ELrepo repo
    action: get_url url=http://downloads.eucalyptus.com/software/eucalyptus/${euca_version}/rhel/6/x86_64/elrepo-release-6.noarch.rpm dest=/root/ thirsty=yes
#    action: command rpm -Uvh /root/elrepo-release-6.noarch.rpm
    
  - name: Install the repo RPM's
    action: command rpm -Uvh /root/eucalyptus-release-${euca_version}.noarch.rpm /root/euca2ools-release-${eucatools_version}.noarch.rpm /root/epel-release-6.noarch.rpm /root/elrepo-release-6.noarch.rpm
    ignore_errors: True
    
  - name: Tidy up
    action: command rm /root/eucalyptus-release-${euca_version}.noarch.rpm euca2ools-release-${eucatools_version}.noarch.rpm epel-release-6.noarch.rpm elrepo-release-6.noarch.rpm
    
# Here we perform a step to register the system with RHN for channel entitlements    
  - name: Register with RHN for dependencies
    action: command rhnreg_ks --username $rhn_username --password $rhn_password --force
 
  - name: install the Eucalyptus RPMs
    action: yum pkg=eucalyptus-enterprise-release.noarch.rpm state=latest
    action: yum pkg=eucalyptus-nc state=latest
    tags: packages
   
  - name: disable firewall
    action: service name=iptables enabled=no state=stopped
    tags: networking
    
#  - name: old read MAC address for interface to add to the bridge
#    action: command ifconfig em1 | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}'
##    register: mac
#   tags: networking
    
  - name: template the interface file
    action: template src=/home/lwade/Documents/Eucalyptus/Software/playbooks/nc/ifconfig_bridge_interface.j2 dest=/etc/sysconfig/network-scripts/ifcfg-${bridge_iface}
    tags: networking
    
#  - name: insert MAC address for desired interface
##    action: lineinfile dest=/etc/sysconfig/network-scripts/ifcfg-${bridge} regexp=^HWADDR line=HWADDR="\"${mac.rc}\""
 ##   tags: template
    
  - name: template the bridge interface file
    action: template src=/home/lwade/Documents/Eucalyptus/Software/playbooks/nc/ifconfig_bridge.j2 dest=/etc/sysconfig/network-scripts/ifcfg-${bridge}
    tags: networking
    
  - name: check for VT enablement
    action: shell egrep '(vmx|smx)' /proc/cpuinfo 
    register: vt_is_enabled
    ignore_errors: true
    tags: tune
    
  - name: error if no VT
    action: fail msg="VT is not enabled on this system, please enable it in the system BIOS before proceeding."
    only_if: "'${vt_is_enabled.rc}' == '1'"
    tags: tune
  
  - name: disable selinux
    action: command /usr/sbin/setenforce 0
    ignore_errors: true
    tags: tune
    
  - name: install tuned and set profile
    action: yum pkg=tuned state=latest
    action: command tuned-adm profile virtual-host
    action: service name=tuned enabled=yes state=started
    tags: tune

  - name: turn on ntp
    action: service name=ntpd state=started enabled=yes
    tags: tune
    
  - name: set loglevel
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^LOGLEVEL line=LOGLEVEL="\"$loglevel\""
    tags: conf
    
  - name: set NC port
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^NC_PORT line=NC_PORT="\"$nc_port\""
    tags: conf
    
  - name: set Hypervisor
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^HYPERVISOR= line=HYPERVISOR="\"$hypervisor\""
    tags: conf
    
  - name: enable virtio for instance root device
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^USE_VIRTIO_ROOT line=USE_VIRTIO_ROOT="\"$virtio_root\""
    tags: conf
    
  - name: enable virtio for instance ebs 
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^USE_VIRTIO_DISK line=USE_VIRTIO_DISK="\"$virtio_block\""
    tags: conf 
    
  - name: enable virtio for instance network adapters
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^USE_VIRTIO_NET line=USE_VIRTIO_NET="\"$virtio_net\""
    tags: conf
    
  - name: set public interface
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^VNET_PUBINTERFACE= line=VNET_PUBINTERFACE="\"$public_iface\""
    tags: conf 
    
  - name: set bridged interface
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^VNET_BRIDGE= line=VNET_BRIDGE="\"$bridge\""
    tags: conf
    
  - name: set network mode
    action: lineinfile dest=/etc/eucalyptus/eucalyptus.conf regexp=^VNET_MODE= line=VNET_MODE="\"$network_mode\""
    tags: conf
    
  - name: bringing up NC
    action: service name=eucalyptus-nc enabled=yes state=started
    tags: awaken
